{
  "name": "VILQA Registration (Fixed)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "vilqa-registration",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [460, 240],
      "id": "webhook-registration",
      "name": "Webhook - Registration"
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ webhook\nconst body = $input.first().json.body;\n\n// –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π\nif (!body.telegram_id) {\n  throw new Error('Missing telegram_id');\n}\n\nif (!body.name || !body.gender || !body.age || !body.height || !body.weight || !body.activity || !body.goal) {\n  throw new Error('Missing required fields');\n}\n\n// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è\nfunction escapeMarkdown(text) {\n  const specialChars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!'];\n  let escaped = String(text);\n  specialChars.forEach(char => {\n    escaped = escaped.replace(new RegExp('\\\\' + char, 'g'), '\\\\' + char);\n  });\n  return escaped;\n}\n\nfunction getGoalFriendly(goal) {\n  const goals = {\n    'lose': '—Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å',\n    'lose_fast': '–±—ã—Å—Ç—Ä–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å',\n    'maintain': '—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º—É',\n    'gain': '–Ω–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É',\n    'gain_fast': '–±—ã—Å—Ç—Ä–æ –Ω–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É'\n  };\n  return goals[goal] || '–¥–æ—Å—Ç–∏—á—å —Ü–µ–ª–∏';\n}\n\nfunction getGoalEmoji(goal) {\n  const emojis = {\n    'lose': 'üìâ',\n    'lose_fast': '‚ö°',\n    'maintain': '‚öñÔ∏è',\n    'gain': 'üìà',\n    'gain_fast': 'üí™'\n  };\n  return emojis[goal] || 'üéØ';\n}\n\nfunction getMotivation(goal) {\n  const motivations = {\n    'lose': 'üå± *–ó–¥–æ—Ä–æ–≤—ã–π —Ç–µ–º–ø:* –ø—Ä–∏–º–µ—Ä–Ω–æ 2 –∫–≥ –≤ –º–µ—Å—è—Ü',\n    'lose_fast': '‚ö° *–ê–∫—Ç–∏–≤–Ω—ã–π —Ç–µ–º–ø:* –æ–∫–æ–ª–æ 3 –∫–≥ –≤ –º–µ—Å—è—Ü',\n    'maintain': '‚öñÔ∏è *–ë–∞–ª–∞–Ω—Å:* —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –≤–µ—Å –∏ –æ—Ç–ª–∏—á–Ω–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ',\n    'gain': 'üí™ *–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç:* –æ–∫–æ–ª–æ 1 –∫–≥ –º—ã—à—Ü –≤ –º–µ—Å—è—Ü',\n    'gain_fast': 'üöÄ *–ë—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç:* –æ–∫–æ–ª–æ 2 –∫–≥ –≤ –º–µ—Å—è—Ü —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏'\n  };\n  return motivations[goal] || 'üéØ *–ì–ª–∞–≤–Ω–æ–µ ‚Äî –ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ\\\\!*';\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è Markdown\nconst safeName = escapeMarkdown(body.name);\nconst safeHeight = escapeMarkdown(body.height);\nconst safeWeight = escapeMarkdown(body.weight);\nconst safeAge = escapeMarkdown(body.age);\nconst safeTdee = escapeMarkdown(body.tdee);\nconst safeTargetCal = escapeMarkdown(body.targetCalories);\nconst safeTimezone = body.timezone || 'UTC';\n\n// –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\nconst greeting = `üëã *–ü—Ä–∏–≤–µ—Ç, ${safeName}\\\\!*\\n\\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VILQA ‚Äî —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∏—Ç–∞–Ω–∏—é`;\nconst goalSection = `\\n\\n${getGoalEmoji(body.goal)} *–¢–≤–æ—è —Ü–µ–ª—å:* ${getGoalFriendly(body.goal)}`;\nconst statsSection = `\\n\\nüìä *–¢–≤–æ–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:*\\n‚Ä¢ –†–æ—Å—Ç: *${safeHeight}* —Å–º\\n‚Ä¢ –í–µ—Å: *${safeWeight}* –∫–≥\\n‚Ä¢ –í–æ–∑—Ä–∞—Å—Ç: *${safeAge}* –ª–µ—Ç\\n‚Ä¢ –†–∞—Å—Ö–æ–¥: \\\\~*${safeTdee}* –∫–∫–∞–ª/–¥–µ–Ω—å`;\nconst recommendationSection = `\\n\\nüéØ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:*\\n–î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ —Å—ä–µ–¥–∞–π –æ–∫–æ–ª–æ *${safeTargetCal} –∫–∫–∞–ª* –≤ –¥–µ–Ω—å`;\nconst motivationSection = `\\n\\n${getMotivation(body.goal)}`;\nconst instructionSection = `\\n\\nüí¨ *–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è?*\\n–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –º–Ω–µ —á—Ç–æ –µ—à—å, –∞ —è –ø–æ—Å—á–∏—Ç–∞—é –∫–∞–ª–æ—Ä–∏–∏\\\\!\\n\\n–ù–∞–ø—Ä–∏–º–µ—Ä: _\"–û–≤—Å—è–Ω–∫–∞ 50–≥, –±–∞–Ω–∞–Ω, –∫–æ—Ñ–µ —Å –º–æ–ª–æ–∫–æ–º\"_`;\n\nconst message = greeting + goalSection + statsSection + recommendationSection + motivationSection + instructionSection;\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –Ω–æ–¥\nreturn {\n  json: {\n    body: body,\n    message: message,\n    timezone: safeTimezone\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 240],
      "id": "prepare-message",
      "name": "Prepare Welcome Message"
    },
    {
      "parameters": {
        "dataTableId": {
          "__rl": true,
          "value": "ExVPrqR3ZTz2hAge",
          "mode": "list",
          "cachedResultName": "users"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $json.body.telegram_id }}",
            "username": "={{ $json.body.telegram_username }}",
            "name": "={{ $json.body.name }}",
            "height": "={{ $json.body.height }}",
            "weight": "={{ $json.body.weight }}",
            "age": "={{ $json.body.age }}",
            "gender": "={{ $json.body.gender }}",
            "activity_level": "={{ $json.body.activity }}",
            "daily_calories": "={{ $json.body.targetCalories }}",
            "daily_protein": "={{ Math.round($json.body.targetCalories * 0.3 / 4) }}",
            "daily_fats": "={{ Math.round($json.body.targetCalories * 0.25 / 9) }}",
            "daily_carbs": "={{ Math.round($json.body.targetCalories * 0.45 / 4) }}",
            "tdee": "={{ $json.body.tdee }}",
            "timezone": "={{ $json.timezone || 'UTC' }}",
            "current_state": "active",
            "state_data": ""
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [860, 240],
      "id": "insert-user",
      "name": "Insert New User"
    },
    {
      "parameters": {
        "chatId": "={{ $('Prepare Welcome Message').item.json.body.telegram_id }}",
        "text": "={{ $('Prepare Welcome Message').item.json.message }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "MarkdownV2"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1060, 240],
      "id": "send-telegram",
      "name": "Send Welcome Message",
      "credentials": {
        "telegramApi": {
          "id": "ddIRTQugzxvbO2sC",
          "name": "VILQA AI bot"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \n  \"success\": true, \n  \"message\": \"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞\",\n  \"user_id\": $('Prepare Welcome Message').item.json.body.telegram_id,\n  \"timestamp\": $now\n} }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json; charset=utf-8"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [1260, 240],
      "id": "response-success",
      "name": "Response Success"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \n  \"success\": false, \n  \"error\": $json.error?.message || $('Webhook - Registration').item.json.body?.error || 'Unknown error',\n  \"timestamp\": $now\n} }}",
        "options": {
          "responseCode": 500,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json; charset=utf-8"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [860, 420],
      "id": "response-error",
      "name": "Response Error"
    }
  ],
  "connections": {
    "Webhook - Registration": {
      "main": [
        [
          {
            "node": "Prepare Welcome Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Welcome Message": {
      "main": [
        [
          {
            "node": "Insert New User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert New User": {
      "main": [
        [
          {
            "node": "Send Welcome Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Welcome Message": {
      "main": [
        [
          {
            "node": "Response Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  }
}
